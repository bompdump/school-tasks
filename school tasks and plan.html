<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מתכנן בית ספר ומנהל משימות</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs - Using compat versions for simpler integration with global firebase object -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- Firebase Cloud Messaging SDK (required for push notifications) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for table on mobile */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background-color: #a0aec0; /* Tailwind gray-400 */
            border-radius: 4px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background-color: #edf2f7; /* Tailwind gray-200 */
        }
        /* Hide scrollbar for Firefox */
        .overflow-x-auto {
            scrollbar-width: thin;
            scrollbar-color: #a0aec0 #edf2f7;
        }
        /* Responsive table cell styling */
        .table-cell-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        @media (max-width: 640px) { /* Small screens / Mobile */
            .table-cell-content {
                min-width: 150px; /* Ensure cells have enough width on small screens */
            }
            .table-auto {
                width: max-content; /* Allow table to grow beyond screen width for scrolling */
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-900 font-inter p-4 sm:p-6 lg:p-8 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 p-4 rounded-lg shadow-lg text-white hidden">
    </div>

    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-blue-700 mb-2 dark:text-blue-300">מערכת שעות כיתה ט 4</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">מתכנן בית ספר ומנהל משימות אישי</p>
        <p class="text-sm text-gray-500 mt-2 dark:text-gray-400">מזהה משתמש: <span id="user-id" class="font-mono bg-gray-200 px-2 py-1 rounded-md dark:bg-gray-700">טוען...</span></p>
        
        <!-- Dark Mode Toggle Button -->
        <button id="dark-mode-toggle" class="mt-4 px-4 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 flex items-center justify-center mx-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
            </svg>
            <span id="dark-mode-text">מצב לילה</span>
        </button>

        <!-- Push Notification Activation Button -->
        <button id="enable-notifications-btn" class="mt-4 px-4 py-2 rounded-lg bg-purple-600 text-white shadow-md hover:bg-purple-700 transition-colors duration-200 flex items-center justify-center mx-auto">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 2a6 6 0 00-6 6c0 1.83.693 3.535 1.867 4.811L5 15.586V16a1 1 0 001 1h8a1 1 0 001-1v-.414l-1.867-2.771A6 6 0 0016 8a6 6 0 00-6-6zm-1.87 9.87a.75.75 0 01-1.06 1.06L7 11.06l-.07.07c-.45.45-.63.99-.54 1.59l.06.3c.09.4.24.77.45 1.09.28.4.63.74 1.02 1.03.45.34.93.63 1.44.86a.75.75 0 01-.75 1.34c-.54-.24-1.07-.56-1.57-.96-.44-.35-.83-.75-1.16-1.19-.24-.32-.42-.68-.53-1.08l-.06-.3c-.09-.45.05-.93.44-1.32zM10 4a4 4 0 00-4 4c0 1.25.462 2.392 1.25 3.32L10 13.5l2.75-2.188A4 4 0 0014 8a4 4 0 00-4-4z" clip-rule="evenodd"></path>
            </svg>
            הפעל התראות Push
        </button>
    </header>

    <!-- Navigation Buttons -->
    <div class="flex justify-center mb-8 space-x-4">
        <button id="weekly-plan-btn" class="py-3 px-6 rounded-lg font-semibold text-lg transition-all duration-300 ease-in-out shadow-md bg-blue-600 text-white transform scale-105">
            תכנית שבועית
        </button>
        <button id="tasks-list-btn" class="py-3 px-6 rounded-lg font-semibold text-lg transition-all duration-300 ease-in-out shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
            משימות
        </button>
    </div>

    <main class="container mx-auto">
        <!-- Weekly Plan View -->
        <div id="weekly-plan-view" class="overflow-x-auto bg-white rounded-xl shadow-xl p-4 dark:bg-gray-800">
            <table class="min-w-full divide-y divide-gray-200 border-collapse table-auto dark:divide-gray-700">
                <thead class="bg-blue-600 text-white dark:bg-blue-800">
                    <tr id="table-header-days">
                        <th class="py-3 px-4 text-right text-sm font-semibold uppercase tracking-wider rounded-tl-xl">שעה / יום</th>
                        <!-- Day headers will be inserted here by JS -->
                    </tr>
                </thead>
                <tbody id="weekly-plan-tbody" class="divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Table content will be inserted here by JS -->
                </tbody>
            </table>
        </div>

        <!-- Tasks List View -->
        <div id="tasks-list-view" class="bg-white rounded-xl shadow-xl p-4 hidden dark:bg-gray-800">
            <h2 class="text-3xl font-bold text-blue-700 mb-6 text-center dark:text-blue-300">כל המשימות</h2>
            <button id="add-new-task-btn" class="mb-6 p-3 bg-green-500 hover:bg-green-600 text-white rounded-lg shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 w-full sm:w-auto">
                + הוסף מטלה חדשה
            </button>

            <div id="tasks-list-container" class="space-y-4">
                <p id="no-tasks-message" class="text-center text-gray-600 text-lg dark:text-gray-400">אין משימות כרגע. הוסף אחת!</p>
                <!-- Tasks will be inserted here by JS -->
            </div>
        </div>
    </main>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden dark:bg-gray-900 dark:bg-opacity-80">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all duration-300 scale-100 dark:bg-gray-800">
            <h3 class="text-2xl font-bold text-blue-700 mb-4 dark:text-blue-300">הוסף מטלה חדשה</h3>
            <form id="add-task-form">
                <div class="mb-4">
                    <label for="taskDescription" class="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300">תיאור מטלה:</label>
                    <input type="text" id="taskDescription" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" required>
                </div>
                <div class="mb-4">
                    <label for="taskSubject" class="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300">נושא:</label>
                    <select id="taskSubject" class="shadow border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" required>
                        <option value="">בחר נושא</option>
                        <!-- Subjects will be populated by JS -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="taskDoDate" class="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300">תאריך לביצוע:</label>
                    <input type="date" id="taskDoDate" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" required>
                </div>
                <div class="mb-6">
                    <label for="taskDueDate" class="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300">תאריך הגשה:</label>
                    <input type="date" id="taskDueDate" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" required>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-colors duration-200">
                        הוסף מטלה
                    </button>
                    <button type="button" id="cancel-add-task" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transition-colors duration-200">
                        ביטול
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Default weekly plan data
        const defaultWeeklyPlanData = {
            name: "מערכת שעות כיתה ט 4",
            schedule: [
                { day: "ראשון", time: "8:15-9:00", subject: "תנ\"ך", teacher: "בר זאב לילך" },
                { day: "ראשון", time: "9:00-9:45", subject: "שלח", teacher: "סנן מישל" },
                { day: "ראשון", time: "10:05-10:50", subject: "ערבית", teacher: "בבא ענבל ליאל" },
                { day: "ראשון", time: "10:50-11:40", subject: "אזרחות", teacher: "ויזל גילה" },
                { day: "ראשון", time: "12:00-12:45", subject: "מתמטיקה", teacher: "יריב ניצה" },
                { day: "ראשון", time: "12:45-13:30", subject: "לשון והבעה", teacher: "דמרי מירב" },
                { day: "ראשון", time: "13:45-14:30", subject: "לשון והבעה", teacher: "דמרי מירב" },

                { day: "שני", time: "8:15-9:00", subject: "מתמטיקה", teacher: "יריב ניצה" },
                { day: "שני", time: "9:00-9:45", subject: "מתמטיקה", teacher: "יריב ניצה" },
                { day: "שני", time: "10:05-10:50", subject: "מדעי המח מדעי הנד", teacher: "איזנטל חלמיש עמי" },
                { day: "שני", time: "10:50-11:40", subject: "פרטני חינוך , ספרות", teacher: "דמרי מירב,קריוק אוד" },
                { day: "שני", time: "12:00-12:45", subject: "פיסיקה", teacher: "נדלר אריה" },
                { day: "שני", time: "12:45-13:30", subject: "חינוך חברה", teacher: "דמרי מירב" },

                { day: "שלישי", time: "8:15-9:00", subject: "ערבית", teacher: "בבא ענבל ליאל" },
                { day: "שלישי", time: "9:00-9:45", subject: "תנ\"ך", teacher: "בר זאב לילך" },
                { day: "שלישי", time: "10:05-10:50", subject: "מתמטיקה", teacher: "אבו קטיש בבאן" },
                { day: "שלישי", time: "10:50-11:40", subject: "מדעי המח מדעי הנד", teacher: "איזנטל חלמיש עמי" },
                { day: "שלישי", time: "12:00-12:45", subject: "מוט", teacher: "אבו קטיש בנאן" },
                { day: "שלישי", time: "12:45-13:30", subject: "מעבדה", teacher: "אבו קסיו במאן" },
                { day: "שלישי", time: "13:45-14:30", subject: "ספחות", teacher: "קריק אודליה" },
                { day: "שלישי", time: "14:30-15:15", subject: "קורס בחירה . A", teacher: "" },
                { day: "שלישי", time: "15:30-16:15", subject: "קורס בחירה . A", teacher: "" },
                { day: "שלישי", time: "16:15-17:00", subject: "חלל", teacher: "הרפז אמיר" },

                { day: "רביעי", time: "8:15-9:00", subject: "מתמטיקה", teacher: "יריב ניצה" },
                { day: "רביעי", time: "9:00-9:45", subject: "אזרחות", teacher: "רזל גילה" },
                { day: "רביעי", time: "10:05-10:50", subject: "לשון והבעה", teacher: "דמרי מירב" },
                { day: "רביעי", time: "10:50-11:40", subject: "הסטוריה", teacher: "כהן דרמר עינת" },
                { day: "רביעי", time: "12:00-12:45", subject: "הסטוריה", teacher: "כהן דרמר עינה" },
                { day: "רביעי", time: "12:45-13:30", subject: "פרטני חנ\"ג בחנ\"ג ב", teacher: "דמרי יוסף רחמילביא" },

                { day: "חמישי", time: "8:15-9:00", subject: "חנ\"ג בנים,חנ\"ג במת", teacher: "סף רחמים לביא ל" },
                { day: "חמישי", time: "9:00-9:45", subject: "פיסיקה", teacher: "נדלר אריה" },
                { day: "חמישי", time: "10:05-10:50", subject: "חיטך/חברה", teacher: "ומרי מירב" },
                { day: "חמישי", time: "10:50-11:40", subject: "I-STEAM", teacher: "צפרוט עדי" },
                { day: "חמישי", time: "12:00-12:45", subject: "I-STEAM", teacher: "צ'יפרוט עדי" },
                { day: "חמישי", time: "12:45-13:30", subject: "אנגלית א", teacher: "ברק ריות" },
                { day: "חמישי", time: "13:45-14:30", subject: "חוגי ספורט", teacher: "יוסף איתן כהן כנען בן" },
                { day: "חמישי", time: "14:30-15:15", subject: "חוגי ספורט", teacher: "יוסף איתן" },
                { day: "חמישי", time: "15:30-16:15", subject: "חוגי ספורט", teacher: "יוסף איתן" },

                { day: "שישי", time: "8:15-9:00", subject: "אנגלית א", teacher: "ברק רינת" },
                { day: "שישי", time: "9:00-9:45", subject: "אנגלית א", teacher: "ברק רינת" },
                { day: "שישי", time: "12:45-13:30", subject: "אנגלית א", teacher: "ברק רינת" },
                { day: "שישי", time: "13:45-14:30", subject: "אנגלית א", teacher: "ברק רינת" },
            ],
        };

        // Firebase Configuration - ** אנא עדכן את הפרטים הבאים מהקונסולה של Firebase שלך **
        // היכנס ל- Firebase Console -> Project settings -> Your apps -> Web app -> "Config"
        const firebaseConfig = {
            apiKey: "AIzaSyBOhNtz9ja7_YcV9Djg53fDcd51jV-MLW0",
            authDomain: "school-tasks-d9f53.firebaseapp.com",
            projectId: "school-tasks-d9f53",
            storageBucket: "school-tasks-d9f53.firebasestorage.app",
            messagingSenderId: "349723543792",
            appId: "1:349723543792:web:eafdebcb5df5b1f3f41a35"
        };

        // VAPID Public Key - ** עליך ליצור מפתח זה בקונסולת Firebase **
        // Firebase Console -> Project settings -> Cloud Messaging -> Web configuration -> "Generate Key Pair"
        const VAPID_PUBLIC_KEY = "BHeBsvnnphaMHzBNtZ1OLMykeUuUp1Ed5AT08fYbXCtgBnH9su6Y7KUUjUS-FxK5ul3VcF1AtK0VX3WshewYuvQ"; // <--- המפתח עודכן כאן!

        let db;
        let auth;
        let messaging; // Firebase Messaging object
        let userId = null;
        let tasks = [];
        let weeklyPlan = null;
        const appId = firebaseConfig.appId; // Use your actual appId from config

        // DOM Elements
        const userIdSpan = document.getElementById('user-id');
        const messageBox = document.getElementById('message-box');
        const weeklyPlanBtn = document.getElementById('weekly-plan-btn');
        const tasksListBtn = document.getElementById('tasks-list-btn');
        const weeklyPlanView = document.getElementById('weekly-plan-view');
        const tasksListView = document.getElementById('tasks-list-view');
        const weeklyPlanTbody = document.getElementById('weekly-plan-tbody');
        const tableHeaderDays = document.getElementById('table-header-days');
        const tasksListContainer = document.getElementById('tasks-list-container');
        const noTasksMessage = document.getElementById('no-tasks-message');
        const addTaskModal = document.getElementById('add-task-modal');
        const addTaskForm = document.getElementById('add-task-form');
        const taskDescriptionInput = document.getElementById('taskDescription');
        const taskSubjectSelect = document.getElementById('taskSubject');
        const taskDoDateInput = document.getElementById('taskDoDate');
        const taskDueDateInput = document.getElementById('taskDueDate');
        const cancelAddTaskBtn = document.getElementById('cancel-add-task');
        const addNewTaskBtn = document.getElementById('add-new-task-btn');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const darkModeText = document.getElementById('dark-mode-text');
        const enableNotificationsBtn = document.getElementById('enable-notifications-btn');


        let messageTimeout = null;

        // Utility function to display messages
        function showMessage(msg, type) {
            if (messageTimeout) {
                clearTimeout(messageTimeout);
            }
            messageBox.textContent = msg;
            messageBox.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
            messageBox.classList.remove('dark:bg-red-700', 'dark:bg-green-700'); // Ensure dark mode colors are cleaned
            if (type === 'error') {
                messageBox.classList.add('bg-red-500', 'dark:bg-red-700');
            } else {
                messageBox.classList.add('bg-green-500', 'dark:bg-green-700');
            }
            messageTimeout = setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
            console.log(`Message: ${msg} (${type})`); // Log all messages
        }

        // Initialize Firebase
        function initializeFirebase() {
            console.log("Initializing Firebase...");
            try {
                if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                    console.error("Firebase config is missing or incomplete. Provided config:", firebaseConfig);
                    showMessage("שגיאה: הגדרות Firebase חסרות. אנא וודא שהקונפיגורציה נכונה.", "error");
                    return;
                }
                
                if (VAPID_PUBLIC_KEY === "YOUR_VAPID_PUBLIC_KEY_HERE" || !VAPID_PUBLIC_KEY) {
                    console.warn("VAPID Public Key is missing or default. Push notifications may not work.");
                    showMessage("אזהרה: מפתח VAPID חסר. ייתכן שהתראות Push לא יעבדו.", "warning");
                }


                const app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore(); // Get Firestore instance using compat global object
                auth = firebase.auth();   // Get Auth instance using compat global object
                messaging = firebase.messaging(); // Get Messaging instance

                console.log("Firebase app initialized. Waiting for authentication state...");

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdSpan.textContent = userId;
                        console.log("User signed in:", userId);
                        await fetchOrCreatePlan();
                        listenForTasks();
                    } else {
                        console.log("No user signed in. Attempting anonymous sign-in.");
                        try {
                            await auth.signInAnonymously();
                            // User state will be updated by onAuthStateChanged listener
                        } catch (error) {
                            console.error("Error during anonymous sign-in:", error);
                            showMessage(`שגיאת אימות: ${error.message}`, "error");
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showMessage(`שגיאת אתחול: ${error.message}`, "error");
            }
        }

        // Helper to get dates for the current week (Sunday to Friday)
        function getWeekDates() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 for Sunday, 1 for Monday...
            const diffToSunday = dayOfWeek; // How many days ago was Sunday

            const sunday = new Date(today);
            sunday.setDate(today.getDate() - diffToSunday);

            const weekDates = {};
            const daysOrder = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי"];

            for (let i = 0; i < daysOrder.length; i++) {
                const currentDay = new Date(sunday);
                currentDay.setDate(sunday.getDate() + i);
                weekDates[daysOrder[i]] = currentDay.toISOString().split('T')[0]; // FormatYYYY-MM-DD
            }
            console.log("Calculated Week Dates:", weekDates);
            return weekDates;
        }
        const weekDates = getWeekDates(); // Ensure this is called once globally

        // Fetch or create weekly plan
        async function fetchOrCreatePlan() {
            console.log("Fetching or creating weekly plan from Firestore...");
            // Using compat SDK's global firebase.firestore()
            const planDocRef = db.collection(`artifacts/${appId}/public/data/weeklyPlans`).doc('class9-4-plan');
            try {
                const docSnap = await planDocRef.get();
                if (docSnap.exists) {
                    weeklyPlan = docSnap.data();
                    console.log("Weekly plan loaded from Firestore:", weeklyPlan);
                } else {
                    await planDocRef.set(defaultWeeklyPlanData);
                    weeklyPlan = defaultWeeklyPlanData;
                    console.log("Default weekly plan created and loaded:", weeklyPlan);
                    showMessage("לוח זמנים שבועי הוטען בהצלחה!", "success");
                }
                renderWeeklyPlan();
                populateSubjectDropdown();
            } catch (error) {
                console.error("Error fetching or creating weekly plan:", error);
                showMessage(`שגיאה בטעינת לוח זמנים: ${error.message}`, "error");
            }
        }

        // Listen for real-time updates to tasks
        function listenForTasks() {
            if (!userId) {
                console.warn("listenForTasks called but userId is null.");
                return;
            }
            console.log("Listening for real-time tasks updates...");
            // Using compat SDK's global firebase.firestore()
            const tasksCollectionRef = db.collection(`artifacts/${appId}/users/${userId}/tasks`);
            tasksCollectionRef.onSnapshot(snapshot => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Sort tasks by dueDate for consistent display in the tasks list
                tasks.sort((a, b) => {
                    if (!a.dueDate || !b.dueDate) return 0; // Handle cases where dueDate might be missing
                    return new Date(a.dueDate) - new Date(b.dueDate);
                });
                console.log("Tasks updated in real-time:", tasks);
                renderWeeklyPlan(); // Re-render plan to update tasks
                renderTasksList(); // Re-render tasks list
            }, error => {
                console.error("Error listening to tasks:", error);
                showMessage(`שגיאה בסנכרון משימות: ${error.message}`, "error");
            });
        }

        // Render Weekly Plan Table
        function renderWeeklyPlan() {
            if (!weeklyPlan) {
                console.warn("renderWeeklyPlan called but weeklyPlan data is not available yet.");
                return;
            }
            console.log("Rendering weekly plan table...");

            const daysOrder = ["ראשון", "שני", "שלישי", "רביעי", "חמישי", "שישי"];
            const timesOrder = [
                "8:15-9:00", "9:00-9:45", "10:05-10:50", "10:50-11:40",
                "12:00-12:45", "12:45-13:30", "13:45-14:30", "14:30-15:15",
                "15:30-16:15", "16:15-17:00"
            ];

            // Build grouped schedule
            const groupedSchedule = {};
            daysOrder.forEach(day => {
                groupedSchedule[day] = {};
                timesOrder.forEach(time => {
                    groupedSchedule[day][time] = null;
                });
            });
            weeklyPlan.schedule.forEach(item => {
                if (groupedSchedule[item.day] && groupedSchedule[item.day][item.time] === null) {
                    groupedSchedule[item.day][time] = item;
                }
            });
            console.log("Grouped schedule for rendering:", groupedSchedule);


            // Render header days
            let headerHtml = `<th class="py-3 px-4 text-right text-sm font-semibold uppercase tracking-wider rounded-tl-xl">שעה / יום</th>`;
            daysOrder.forEach(day => {
                headerHtml += `
                    <th class="py-3 px-4 text-right text-sm font-semibold uppercase tracking-wider">
                        ${day} <span class="block text-xs font-normal opacity-80">${weekDates[day]}</span>
                    </th>
                `;
            });
            tableHeaderDays.innerHTML = headerHtml;
            console.log("Table header rendered with HTML:", headerHtml);

            // Render table body
            let tbodyHtml = '';
            timesOrder.forEach(time => {
                tbodyHtml += `<tr class="hover:bg-gray-50 transition-colors duration-200 dark:hover:bg-gray-700">
                    <td class="py-3 px-4 whitespace-nowrap font-medium text-gray-900 bg-gray-100 rounded-bl-xl border-r border-gray-200 dark:text-gray-100 dark:bg-gray-700 dark:border-gray-700">
                        ${time}
                    </td>`;
                daysOrder.forEach(day => {
                    const slot = groupedSchedule[day] ? groupedSchedule[day][time] : null;
                    // Filter tasks for the current subject, current day (doDate), and not completed
                    const tasksForSlot = tasks.filter(task =>
                        task.subject === slot?.subject &&
                        task.doDate === weekDates[day] &&
                        !task.isCompleted
                    );
                    // Filter completed tasks for the current subject and current day (doDate)
                    const completedTasksForSlot = tasks.filter(task =>
                        task.subject === slot?.subject &&
                        task.doDate === weekDates[day] &&
                        task.isCompleted
                    );

                    tbodyHtml += `
                        <td class="py-3 px-4 align-top border-r border-gray-200 last:border-r-0 dark:border-gray-700">
                            ${slot ? `
                                <div class="table-cell-content">
                                    <div class="font-semibold text-blue-700 text-lg mb-1 dark:text-blue-300">${slot.subject}</div>
                                    <div class="text-sm text-gray-600 mb-2 dark:text-gray-400">${slot.teacher}</div>
                                    <div class="flex-grow">
                                        ${tasksForSlot.length > 0 ? `
                                            <div class="mt-2 text-sm">
                                                <h4 class="font-bold text-gray-800 mb-1 dark:text-gray-200">מטלות לביצוע:</h4>
                                                <ul class="list-disc list-inside space-y-1">
                                                    ${tasksForSlot.map(task => `
                                                        <li class="flex items-center justify-between bg-yellow-50 p-2 rounded-md shadow-sm dark:bg-yellow-900">
                                                            <div class="flex-1">
                                                                <span class="font-medium text-gray-800 dark:text-gray-200">${task.description}</span>
                                                                <span class="block text-xs text-gray-500 dark:text-gray-400">תאריך הגשה: ${task.dueDate}</span>
                                                            </div>
                                                            <div class="flex space-x-2 ml-2">
                                                                <button onclick="handleToggleTaskComplete('${task.id}', ${task.isCompleted})"
                                                                    class="p-1 rounded-full bg-green-500 hover:bg-green-600 text-white transition-colors duration-200" title="סמן כבוצע">
                                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                                                </button>
                                                                <button onclick="handleDeleteTask('${task.id}')"
                                                                    class="p-1 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors duration-200" title="מחק מטלה">
                                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm-2 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                                                                </button>
                                                            </div>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${completedTasksForSlot.length > 0 ? `
                                            <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                                <h4 class="font-bold mb-1">מטלות שהושלמו:</h4>
                                                <ul class="list-disc list-inside space-y-1 opacity-70">
                                                    ${completedTasksForSlot.map(task => `
                                                        <li class="flex items-center justify-between line-through italic bg-gray-50 p-2 rounded-md shadow-sm dark:bg-gray-700">
                                                            <div class="flex-1">
                                                                <span class="font-medium">${task.description}</span>
                                                                <span class="block text-xs">תאריך הגשה: ${task.dueDate}</span>
                                                            </div>
                                                            <div class="flex space-x-2 ml-2">
                                                                <button onclick="handleToggleTaskComplete('${task.id}', ${task.isCompleted})"
                                                                    class="p-1 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white transition-colors duration-200" title="סמן כלא בוצע">
                                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                                                </button>
                                                                <button onclick="handleDeleteTask('${task.id}')"
                                                                    class="p-1 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors duration-200" title="מחק מטלה">
                                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm-2 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                                                                </button>
                                                            </div>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <button onclick="openAddTaskModal('${slot.subject}', '${day}')"
                                        class="mt-2 p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-md transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">
                                        + הוסף מטלה
                                    </button>
                                </div>
                            ` : `
                                <div class="text-gray-400 text-center italic dark:text-gray-600">
                                    אין שיעור
                                </div>
                            `}
                        </td>
                    `;
                });
                tbodyHtml += `</tr>`;
            });
            weeklyPlanTbody.innerHTML = tbodyHtml;
            console.log("Weekly plan table rendered with HTML:", tbodyHtml); // Log the generated HTML
        }

        // Render Tasks List
        function renderTasksList() {
            console.log("Rendering tasks list. Current tasks:", tasks); // Log tasks
            if (tasks.length === 0) {
                noTasksMessage.classList.remove('hidden');
                tasksListContainer.innerHTML = ''; // Clear previous tasks
                tasksListContainer.appendChild(noTasksMessage); // Re-add message if no tasks
                console.log("No tasks to render.");
            } else {
                noTasksMessage.classList.add('hidden');
                let tasksHtml = '';
                tasks.forEach(task => {
                    tasksHtml += `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-lg shadow-md transition-colors duration-200
                            ${task.isCompleted ? 'bg-gray-100 line-through text-gray-500 opacity-80 dark:bg-gray-700 dark:text-gray-400' : 'bg-white border border-blue-200 dark:bg-gray-800 dark:border-blue-700'}">
                            <div class="flex-1 mb-2 sm:mb-0">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${task.description}</h3>
                                <p class="text-sm text-gray-700 dark:text-gray-300">נושא: <span class="font-medium">${task.subject}</span></p>
                                <p class="text-sm text-gray-700 dark:text-gray-300">תאריך לביצוע: <span class="font-medium">${task.doDate}</span></p>
                                <p class="text-sm text-gray-700 dark:text-gray-300">תאריך הגשה: <span class="font-medium">${task.dueDate}</span></p>
                            </div>
                            <div class="flex flex-row space-x-2 sm:ml-4">
                                <button onclick="handleToggleTaskComplete('${task.id}', ${task.isCompleted})"
                                    class="p-2 rounded-full text-white transition-colors duration-200 ${task.isCompleted ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'}"
                                    title="${task.isCompleted ? "סמן כלא בוצע" : "סמן כבוצע"}">
                                    ${task.isCompleted ? `
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                                    ` : `
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                    `}
                                </button>
                                <button onclick="handleDeleteTask('${task.id}')"
                                    class="p-2 rounded-full bg-red-500 hover:bg-red-600 text-white transition-colors duration-200" title="מחק מטלה">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm-2 4a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                });
                tasksListContainer.innerHTML = tasksHtml;
                console.log("Tasks list rendered with HTML:", tasksHtml); // Log the generated HTML
            }
        }

        // Populate Subject Dropdown in Add Task Modal
        function populateSubjectDropdown() {
            if (!weeklyPlan) {
                console.warn("populateSubjectDropdown called but weeklyPlan data is not available yet. Cannot populate subjects.");
                return;
            }
            const uniqueSubjects = [...new Set(weeklyPlan.schedule.map(item => item.subject))];
            taskSubjectSelect.innerHTML = '<option value="">בחר נושא</option>'; // Always ensure this option is there
            uniqueSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                taskSubjectSelect.appendChild(option);
            });
            console.log("Subject dropdown populated with:", uniqueSubjects);
            if (uniqueSubjects.length === 0) {
                console.warn("No unique subjects found in weeklyPlan.schedule. Ensure defaultWeeklyPlanData is valid.");
            }
        }

        // Handle adding a new task
        async function handleAddTask(e) {
            e.preventDefault();
            if (!db || !userId) {
                showMessage("שגיאה: מסד הנתונים אינו מוכן או המשתמש אינו מאומת.", "error");
                return;
            }

            const description = taskDescriptionInput.value;
            const subject = taskSubjectSelect.value;
            const doDate = taskDoDateInput.value;
            const dueDate = taskDueDateInput.value;

            if (!description || !subject || !doDate || !dueDate) {
                showMessage("אנא מלא את כל שדות המטלה.", "error");
                return;
            }

            try {
                const docRef = await db.collection(`artifacts/${appId}/users/${userId}/tasks`).add({
                    description: description,
                    subject: subject,
                    doDate: doDate,
                    dueDate: dueDate,
                    isCompleted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                });
                showMessage("המטלה נוספה בהצלחה!", "success");
                addTaskModal.classList.add('hidden');
                addTaskForm.reset(); // Clear form
                console.log("Task added:", { description, subject, doDate, dueDate, id: docRef.id });
            }
            catch (error) {
                console.error("Error adding task:", error);
                showMessage(`שגיאה בהוספת מטלה: ${error.message}`, "error");
            }
        }

        // Handle marking task as complete/incomplete
        async function handleToggleTaskComplete(taskId, isCompleted) {
            if (!db || !userId) {
                showMessage("שגיאה: מסד הנתונים אינו מוכן או המשתמש אינו מאומת.", "error");
                return;
            }
            try {
                const taskDocRef = db.collection(`artifacts/${appId}/users/${userId}/tasks`).doc(taskId);
                await taskDocRef.update({ isCompleted: !isCompleted });
                showMessage("סטטוס המטלה עודכן!", "success");
                console.log(`Task ${taskId} toggled to completed: ${!isCompleted}`);
            } catch (error) {
                console.error("Error toggling task complete:", error);
                showMessage(`שגיאה בעדכון מטלה: ${error.message}`, "error");
            }
        }

        // Handle deleting a task
        async function handleDeleteTask(taskId) {
            if (!db || !userId) {
                showMessage("שגיאה: מסד הנתונים אינו מוכן או המשתמש אינו מאומת.", "error");
                return;
            }
            try {
                const taskDocRef = db.collection(`artifacts/${appId}/users/${userId}/tasks`).doc(taskId);
                await taskDocRef.delete();
                showMessage("המטלה נמחקה בהצלחה!", "success");
                console.log(`Task ${taskId} deleted.`);
            } catch (error) {
                console.error("Error deleting task:", error);
                showMessage(`שגיאה במחיקת מטלה: ${error.message}`, "error");
            }
        }

        // Open Add Task Modal
        function openAddTaskModal(subject = '', day = '') {
            taskDescriptionInput.value = '';
            taskSubjectSelect.value = subject;
            taskDoDateInput.value = day ? weekDates[day] : ''; // Pre-fill if day is provided
            taskDueDateInput.value = '';
            addTaskModal.classList.remove('hidden');
            console.log(`Opening add task modal. Pre-filled subject: ${subject}, day: ${day}`);
        }

        // Dark Mode Logic
        function toggleDarkMode() {
            const isDarkMode = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            darkModeText.textContent = isDarkMode ? 'מצב יום' : 'מצב לילה';
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                darkModeText.textContent = 'מצב יום';
            } else {
                document.documentElement.classList.remove('dark');
                darkModeText.textContent = 'מצב לילה';
            }
        }

        // Push Notification Logic
        async function enablePushNotifications() {
            console.log("Attempting to enable push notifications...");
            if (!('serviceWorker' in navigator)) {
                showMessage('שגיאה: הדפדפן אינו תומך ב-Service Workers.', 'error');
                console.error('Service Workers not supported.');
                return;
            }

            if (!('PushManager' in window)) {
                showMessage('שגיאה: הדפדפן אינו תומך ב-Push API.', 'error');
                console.error('Push API not supported.');
                return;
            }

            // Register Service Worker
            try {
                const registration = await navigator.serviceWorker.register('service-worker.js');
                console.log('Service Worker registered:', registration);
                showMessage('Service Worker נרשם בהצלחה.', 'success');

                // Request Notification Permission
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    showMessage('הרשאה להתראות ניתנה.', 'success');

                    if (VAPID_PUBLIC_KEY === "YOUR_VAPID_PUBLIC_KEY_HERE" || !VAPID_PUBLIC_KEY) {
                        showMessage("שגיאה: מפתח VAPID ציבורי חסר או לא תקין. התראות Push לא יעבדו.", "error");
                        console.error("VAPID Public Key is not configured correctly.");
                        return;
                    }

                    // Get FCM registration token (this is the key to sending messages via FCM)
                    const fcmToken = await messaging.getToken({ vapidKey: VAPID_PUBLIC_KEY });
                    console.log('FCM Registration Token:', fcmToken);

                    // You need to send this fcmToken to your backend server (e.g., to Firestore with userId)
                    // so your server can send notifications to this specific device.
                    if (userId && db) {
                        const userTokensRef = db.collection(`artifacts/${appId}/users/${userId}/fcmTokens`).doc(fcmToken);
                        await userTokensRef.set({ token: fcmToken, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                        console.log("FCM token saved to Firestore for user:", userId);
                        showMessage("התראות הופעלו בהצלחה! (ונוקשרו למשתמש)", "success");
                    } else {
                        showMessage("התראות הופעלו, אך לא ניתן לשייך למשתמש (אין userId).", "warning");
                    }

                } else {
                    showMessage('הרשאה להתראות נדחתה.', 'error');
                    console.warn('Notification permission denied.');
                }
            } catch (error) {
                console.error('Error enabling push notifications:', error);
                showMessage(`שגיאה בהפעלת התראות Push: ${error.message}`, 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            applyInitialTheme(); // Apply theme on load
        });

        weeklyPlanBtn.addEventListener('click', () => {
            weeklyPlanView.classList.remove('hidden');
            tasksListView.classList.add('hidden');
            weeklyPlanBtn.classList.add('bg-blue-600', 'text-white', 'transform', 'scale-105');
            weeklyPlanBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:text-gray-200', 'dark:hover:bg-gray-600');
            tasksListBtn.classList.remove('bg-blue-600', 'text-white', 'transform', 'scale-105');
            tasksListBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:text-gray-200', 'dark:hover:bg-gray-600');
            console.log("Switched to Weekly Plan view.");
        });

        tasksListBtn.addEventListener('click', () => {
            tasksListView.classList.remove('hidden');
            weeklyPlanView.classList.add('hidden');
            tasksListBtn.classList.add('bg-blue-600', 'text-white', 'transform', 'scale-105');
            tasksListBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:text-gray-200', 'dark:hover:bg-gray-600');
            weeklyPlanBtn.classList.remove('bg-blue-600', 'text-white', 'transform', 'scale-105');
            weeklyPlanBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300', 'dark:bg-gray-700', 'dark:text-gray-200', 'dark:hover:bg-gray-600');
            console.log("Switched to Tasks List view.");
        });

        addTaskForm.addEventListener('submit', handleAddTask);
        cancelAddTaskBtn.addEventListener('click', () => {
            addTaskModal.classList.add('hidden');
            console.log("Add task modal closed.");
        });
        addNewTaskBtn.addEventListener('click', () => openAddTaskModal()); // Open empty modal from tasks list
        darkModeToggle.addEventListener('click', toggleDarkMode); // Dark mode toggle listener
        enableNotificationsBtn.addEventListener('click', enablePushNotifications); // Push notifications button listener

        // Expose functions to global scope for HTML event handlers
        window.handleToggleTaskComplete = handleToggleTaskComplete;
        window.handleDeleteTask = handleDeleteTask;
        window.openAddTaskModal = openAddTaskModal;
    </script>
</body>
</html>
